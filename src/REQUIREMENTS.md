# 羊了个羊游戏 - 选择区域卡牌生成需求文档

## 概述
实现游戏选择区域的多层卡牌生成系统,包括卡牌布局、类型分配、重叠判定和点击交互逻辑。

---

## 需求1: 基础棋盘数组生成

### 功能描述
生成一个 n×n 的二维布尔数组(1号数组),用于定义卡牌的布局模板。

### 具体要求
- **数组类型**: `boolean[][]`
- **数组大小**: n×n (n值可配置)
- **值含义**:
  - `false`: 空白卡牌位置
    - 完全不可见(无边框、无底色、无背景纹理)
    - 不参与点击判定
    - 不参与遮挡判定
    - 纯占位作用
  - `true`: 正常卡牌位置
    - 可见可交互
    - 添加点击函数(点击效果预留,待后续实现)

### 配置参数
- `gridSize`: 棋盘大小 (默认值待定)

---

## 需求2: 卡牌类型数组生成

### 功能描述
生成一个 n×n 的卡牌类型数组(2号数组),根据1号数组为正常卡牌位置随机分配卡牌类型。

### 具体要求
- **数组类型**: `CardType[][]` (或 `number[][]` / `string[][]`)
- **数组大小**: n×n (与1号数组相同)
- **生成逻辑**:
  - 遍历1号数组
  - 当位置为 `true` 时,从卡牌类型池中随机选择一个类型
  - 当位置为 `false` 时,该位置不分配类型(可设为 `null` 或特殊值)

### 依赖
- 需要卡牌类型池(一维数组)

---

## 需求3: 卡牌类型配置与尺寸

### 功能描述
定义可用的卡牌类型集合,并设置卡牌的显示尺寸。

### 卡牌类型池
- **数据结构**: 一维数组
- **类型数量**: n 种 (可配置,默认 3 种)
- **配置参数**: `cardTypes: string[]` 或 `CardType[]`

### 卡牌尺寸
- **长宽比**: 黄金分割比 (1 : 1.618)
- **短边**: 宽度
- **精度**: 整数像素值
- **计算示例**:
  ```
  如果宽度 = 60px
  则高度 = Math.round(60 × 1.618) = 97px
  ```

### 配置参数
```javascript
{
  cardTypeCount: 3,           // 卡牌类型数量
  cardTypes: ['A', 'B', 'C'], // 卡牌类型定义
  cardWidth: 60,              // 卡牌宽度(px)
  cardHeight: 97              // 卡牌高度(px,自动计算)
}
```

---

## 需求4: 多层卡牌布局系统

### 功能描述
自动生成多个2号数组,形成多层卡牌堆叠效果,并按规则进行偏移。

### 层数配置
- **生成数量**: 可配置,默认 10 层
- **配置参数**: `layerCount: 10`

### 偏移规则

#### 奇数层 (1, 3, 5, 7, 9...)
- **偏移量**: 无偏移
- **位置**: 与第1层完全重叠

#### 偶数层 (2, 4, 6, 8, 10...)
- **偏移量**:
  - X轴: ± 半个卡牌宽度
  - Y轴: ± 半个卡牌高度
- **偏移方向**: 随机选择(4个方向)
  - 右下: `(+width/2, +height/2)`
  - 右上: `(+width/2, -height/2)`
  - 左下: `(-width/2, +height/2)`
  - 左上: `(-width/2, -height/2)`

### 偏移计算示例
```javascript
// 假设卡牌宽60px, 高97px
const offsetX = cardWidth / 2;   // 30px
const offsetY = cardHeight / 2;  // 48.5px → 49px

// 第2层随机选择一个方向
// 第4层再随机选择一个方向
// ...以此类推
```

### 数据结构
```javascript
layers = [
  { layerIndex: 0, grid: [[...]], offsetX: 0, offsetY: 0 },
  { layerIndex: 1, grid: [[...]], offsetX: 30, offsetY: 49 },
  { layerIndex: 2, grid: [[...]], offsetX: 0, offsetY: 0 },
  { layerIndex: 3, grid: [[...]], offsetX: -30, offsetY: 49 },
  // ...
]
```

---

## 需求5: 重叠判定与点击判定系统

### 5.1 点击权限
- **可点击**: 仅正常卡牌 (`true` 位置的卡牌)
- **不可点击**: 空白卡牌 (`false` 位置)

### 5.2 锁机制

#### 锁的定义
- 每个正常卡牌有一个 **锁数** 属性 (`lockCount`)
- 锁数可以为 0 或任意正整数
- 一个卡牌可以被多个上层卡牌同时锁住

#### 锁的状态
- **未被锁** (`lockCount === 0`):
  - 允许参与点击判定
  - 允许参与重叠判定
- **被锁** (`lockCount > 0`):
  - **不允许**参与点击判定
  - 允许参与重叠判定

#### 初始化
- 游戏开始时,所有正常卡牌的 `lockCount = 0`

### 5.3 重叠判定逻辑

#### 判定时机
- 在游戏初始化完成后,所有层级卡牌生成完毕后执行一次

#### 判定流程
1. **遍历顺序**: 从最上层(最后一层)开始,逐层向下遍历
2. **穿透层数**: 每个正常卡牌向下穿透 **2层**
3. **检测方法**: 检测该卡牌的 **四个角坐标** 下方是否有正常卡牌
4. **上锁操作**: 对检测到的每个正常卡牌,`lockCount += 1`

#### 四个角坐标定义
假设卡牌中心坐标为 `(centerX, centerY)`,宽度为 `w`,高度为 `h`:
```javascript
const corners = [
  { x: centerX - w/2, y: centerY - h/2 }, // 左上角
  { x: centerX + w/2, y: centerY - h/2 }, // 右上角
  { x: centerX - w/2, y: centerY + h/2 }, // 左下角
  { x: centerX + w/2, y: centerY + h/2 }  // 右下角
];
```

#### 检测范围
- 当前层为第 `i` 层
- 向下检测第 `i-1` 层和第 `i-2` 层
- 如果下方没有足够层数,只检测存在的层

#### 空白卡牌处理
- 空白卡牌 **不参与** 重叠判定
- 即使检测到空白卡牌位置,也不进行任何操作

### 5.4 点击判定逻辑

#### 点击条件
```javascript
if (card.isNormalCard && card.lockCount === 0) {
  // 允许点击
}
```

#### 点击效果
1. **卡牌移除**: 该卡牌从选择区域移除(移动到消除区域,具体逻辑待后续实现)
2. **解锁操作**:
   - 找到所有被该卡牌锁住的下层卡牌
   - 对每个被锁卡牌执行 `lockCount -= 1`

#### 解锁卡牌追踪
需要维护一个映射关系:
```javascript
// 数据结构示例
card.lockedCards = [
  { layerIndex: 3, row: 2, col: 5 },
  { layerIndex: 4, row: 2, col: 5 },
  // ...
]
```

---

## 数据结构设计

### Card 对象
```javascript
{
  layerIndex: number,      // 所属层级
  row: number,             // 行索引
  col: number,             // 列索引
  isNormalCard: boolean,   // 是否为正常卡牌(对应1号数组的值)
  cardType: string | null, // 卡牌类型(对应2号数组的值)
  lockCount: number,       // 锁数
  lockedCards: Array,      // 该卡牌锁住的下层卡牌列表
  x: number,               // 渲染X坐标
  y: number,               // 渲染Y坐标
  sprite: Phaser.GameObjects // Phaser精灵对象
}
```

### Layer 对象
```javascript
{
  layerIndex: number,
  boolGrid: boolean[][],    // 1号数组
  typeGrid: (string|null)[][], // 2号数组
  offsetX: number,
  offsetY: number,
  cards: Card[][]           // 卡牌对象二维数组
}
```

---

## 配置参数汇总

建议放入 `src/config/gameConfig.js` 的新增配置:

```javascript
// 卡牌系统配置
card: {
  // 棋盘大小
  gridSize: 8,              // 8x8 棋盘

  // 卡牌类型
  cardTypeCount: 3,         // 卡牌类型数量
  cardTypes: ['sheep', 'cow', 'pig'], // 卡牌类型标识

  // 卡牌尺寸
  cardWidth: 60,            // 卡牌宽度(px)
  cardHeight: 97,           // 卡牌高度(px, 根据黄金分割比计算)

  // 层级配置
  layerCount: 10,           // 层数

  // 重叠判定
  overlapCheckDepth: 2,     // 向下穿透层数

  // 视觉配置
  cardBorderColor: '#333333',
  cardBackgroundColor: '#FFFFFF',
  lockedCardAlpha: 0.7,     // 被锁卡牌的透明度
  unlockedCardAlpha: 1.0    // 未被锁卡牌的透明度
}
```

---

## 实现步骤建议

### 阶段1: 数据生成
1. 生成1号bool数组
2. 根据1号数组生成单个2号类型数组
3. 生成多层2号数组(带偏移)

### 阶段2: 渲染系统
1. 在选择区域绘制多层卡牌
2. 实现卡牌的视觉样式(正常卡牌 vs 空白卡牌)
3. 实现被锁/未被锁的视觉区分

### 阶段3: 判定系统
1. 实现重叠判定算法
2. 初始化所有卡牌的锁数
3. 实现点击判定逻辑

### 阶段4: 交互系统
1. 添加卡牌点击事件
2. 实现解锁逻辑
3. 预留卡牌移动到消除区域的接口

---

## 注意事项

1. **性能优化**:
   - 重叠判定只在初始化时执行一次
   - 使用空间索引优化角坐标检测

2. **边界处理**:
   - 处理偏移后卡牌可能超出选择区域边界的情况
   - 考虑是否需要限制偏移范围

3. **调试支持**:
   - 建议添加调试模式,显示锁数、层级等信息
   - 可视化重叠判定的检测区域

4. **扩展性**:
   - 预留不同难度级别的配置接口
   - 支持自定义卡牌生成策略

---

## 验证标准

- [ ] 1号数组正确生成,空白卡牌不可见
- [ ] 2号数组正确分配卡牌类型
- [ ] 多层卡牌按规则正确偏移
- [ ] 重叠判定正确计算所有卡牌的锁数
- [ ] 只有lockCount=0的卡牌可以点击
- [ ] 点击后正确解锁下层卡牌
- [ ] 空白卡牌不参与任何判定逻辑
